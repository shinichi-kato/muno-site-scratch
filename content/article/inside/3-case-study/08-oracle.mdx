---
title: "夢の話ボット"
color: "secondary"
updated: "2022-07-29T12:00Z"
featuredImage: "./cascade.jpg"
tags: 
    - "Tag Decoder"
---

チャットボットの反応をバリエーションに富んだものにすることは重要ですが、人間がさまざまな回答を事前に考えて辞書を作るのは非常に大変な作業です。
そこで<Link to="/article/inside/2-basic/04-text-generation/01-markov">マルコフ連鎖による文生成</Link>を用いてログやコーパスを自動的に辞書化する方法を考えます。

マルコフ連鎖では、直前の一文字を見て次の一文字を決める方法だとログが大きくなるにつれ生成されるテキストが無秩序化してしまう傾向がありますが、連鎖の単位を文字ではなく形態素にしたり、先行する文字を一文字から複数文字にするといった方法でそれを軽減することができる、ということを見てきました。
Fig. 1は<Link to="/article/inside/2-basic/04-text-generation/01-markov">マルコフ連鎖による文生成</Link>で示したものであり、横軸が次候補の数で縦がその頻度を表すヒストグラムで、青がuni-gram(先行する一文字を考慮)、赤がbi-gram(先行する二文字を考慮)です。
これを見ると次候補の数が1である左端のピーク高さはbi-gramで0.7となっており、元の文書を再現する確率が高いことが分かります。また次候補の数が2以上の裾野はbi-gramの方が小さくなっていることからも同様の傾向が見て取れます。
つまりこの方法では無秩序化の軽減が進むと同時に元のテキストの単なる再現に近くなってしまうということで、これではあまり面白くありません。
自然言語としての秩序を保ったままテキスト生成の幅を広げることはできるでしょうか。

![Fig. 1. 二文字を考慮したマルコフ連鎖のヒストグラム](../04-text-generation/2gram.png)

テキストが不自然かどうかを計算することは難しく、例えば鈴木ら[^1]はn-gramに対応したニューラルネットワークを作り、それによる判断を試みています。
しかしマルコフ連鎖で生成したテキストはそもそもn-gramのルールに則っているため、この方法での分類では検出力がないと思われます。

[^1]:[鈴井 克徳ら, DEIM Forum 2018 G3-4](https://db-event.jpn.org/deim2018/data/papers/298.pdf)

次に確認したいのは出現頻度が高く、次の候補の数が多い語句の内容です。

* ログをそのまま使う→ログ型
* ログを分解してマルコフ連鎖にする→マルコフ連鎖型
* さらにマルコフ連鎖になったノードを観察して人間がそれをふくらませる
* マルコフ連鎖で何をきっかけに任意のマルコフ連鎖がスタートするのかを決めるのは難しいが、「夢の話」「お告げ」「占い」などの体であればおもしろい
* 小説を使う場合は地の文と発言「」を分離してそれぞれ別のマルコフ連鎖にする→スタックのあるマルコフ連鎖
* 意味で区切るマルコフ連鎖やngramを考える



辞書に書き込んだチャットボットのセリフは同じものが何度か現れるとすぐに飽きてきます。
とはいえ辞書に大量のセリフを書き込むことは辞書製作者にとっても結構大変な作業です。これらを回避しつつ豊かな発話をさせるにはどうしたらいいでしょうか。
その一つの解決策がタグを利用したテキスト生成です。

## タグを展開するエンコーダ
例えば辞書に以下のような記述をします。

```
in:[
    "{animal}"
],
out:[
    "犬","猫","イルカ","アゲハチョウ","恐竜"
],
in:[
    "好きな動物は？"
],
out:[
    "{animal}が好きだよ"
]
```

ここでinやoutのなかで`{animal}`と書かれている部分をタグと呼びます。outの文字列にタグが含まれたらinの中に同じタグを見つけて、その中からランダムに一つを使います。
これにより、「`{animal}`が好きだよ」という辞書の文字列は「犬が好きだよ」「猫が好きだよ」・・・としてユーザへの返答になります。

この処理をするためには

## 辞書の可読性と概念化

ここで、辞書の可読性について考えます。

* 助詞と動詞＋送り仮名、サ変動詞の結合、形態素→句読点の結合
* 文末から文頭に向かうマルコフ連鎖生成。文頭文字を付ける必要があり、
* セリフと地の文の区別



りんごが好き
猫が好き
景色を見るのが好き
猫を見るのが好き

のようにかかり受けが右から左になる場合が多いので、マルコフ連鎖も末尾から先頭に向かって進める
これにより「好きな何か」という概念がマルコフ連鎖の中に形成され、それを人間が後から改造しやすくなる

辞書化する際は

{node001}:["りんご","猫","{node003}を見るの"]
{node002}:["{node001}が好き"]
{node003}:["景色","猫"]

のようになるはず。
